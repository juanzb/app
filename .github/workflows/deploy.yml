name: CD - Deploy NestJS App

# Se ejecuta automáticamente cuando el CI termina exitosamente
on:
  workflow_run:
    workflows: ['CI - NestJS'] # Nombre exacto de tu workflow de CI
    types:
      - completed

jobs:
  deploy:
    # Solo corre si el CI fue exitoso
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout del repo en el runner (necesario para git pull)
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Conéctate al servidor y despliega
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # Ir a la carpeta de la app
            cd /home/ubuntu/app-deploy

            # Si no hay repo inicial, clonar por primera vez
            if [ ! -d ".git" ]; then
              git init
              git remote add origin https://github.com/<TU_USUARIO>/<TU_REPO>.git
              git fetch
              git reset --hard origin/main
            else
              git fetch
              git reset --hard origin/main
            fi

            # Instala Node, pnpm y PM2 si no están
            if ! command -v node >/dev/null 2>&1; then
              curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi

            if ! command -v pnpm >/dev/null 2>&1; then
              sudo npm install -g pnpm@latest-10
            fi

            if ! command -v pm2 >/dev/null 2>&1; then
              sudo npm install -g pm2
            fi

            # Instala dependencias y compila en producción
            pnpm install --prod
            pnpm run build

            # Verifica que el build exista
            if [ ! -f dist/main.js ]; then
              echo "Error: dist/main.js no encontrado!"
              exit 1
            fi

            # Reinicia o inicia la app con PM2
            pm2 restart nest-app || pm2 start dist/main.js --name nest-app

            # Guarda configuración de PM2 para reinicio automático
            pm2 save
